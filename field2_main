import os
import json
import re
from pathlib import Path

# üîπ Input folder (field-level JSON files)
field_input_dir = Path(r"C:\Users\HariharaM12\PycharmProjects\New_project\output\fields")

# üîπ Output folders for individual fields
performance_output_dir = Path(r"C:\Users\HariharaM12\PycharmProjects\New_project\output\performance_status_fields")
mutation_output_dir = Path(r"C:\Users\HariharaM12\PycharmProjects\New_project\output\mutational_status_fields")
precedent_output_dir = Path(r"C:\Users\HariharaM12\PycharmProjects\New_project\output\precedent_disease_fields")

# üîπ Create folders if they don‚Äôt exist
os.makedirs(performance_output_dir, exist_ok=True)
os.makedirs(mutation_output_dir, exist_ok=True)
os.makedirs(precedent_output_dir, exist_ok=True)

# üîπ Helper to clean up file names
def sanitize_filename(name: str) -> str:
    return re.sub(r'[\\/*?:"<>|]', "_", name)

# üîÅ Process each field file
for filename in os.listdir(field_input_dir):
    if not filename.endswith(".json"):
        continue

    input_path = field_input_dir / filename
    try:
        with open(input_path, 'r', encoding='utf-8') as f:
            content = f.read().strip()
        if not content:
            print(f"‚ö†Ô∏è Skipping empty file: {filename}")
            continue
        data = json.loads(content)
    except Exception as e:
        print(f"‚ùå Error reading {filename}: {e}")
        continue

    document_title = data.get("document_title", filename.replace(".json", ""))
    safe_filename = sanitize_filename(document_title) + ".json"

    # ‚úÖ Save performance_status
    performance_data = {
        "document_title": document_title,
        "performance_status": data.get("performance_status", {})
    }
    with open(performance_output_dir / safe_filename, 'w', encoding='utf-8') as f:
        json.dump(performance_data, f, indent=4)

    # ‚úÖ Save mutational_status
    mutation_data = {
        "document_title": document_title,
        "mutational_status": data.get("mutational_status", {})
    }
    with open(mutation_output_dir / safe_filename, 'w', encoding='utf-8') as f:
        json.dump(mutation_data, f, indent=4)

    # ‚úÖ Save precedent_disease
    precedent_data = {
        "document_title": document_title,
        "precedent_disease": data.get("precedent_disease", [])
    }
    with open(precedent_output_dir / safe_filename, 'w', encoding='utf-8') as f:
        json.dump(precedent_data, f, indent=4)

    print(f"‚úÖ Saved: {safe_filename}")
